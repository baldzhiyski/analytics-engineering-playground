version: "3.8"

x-airflow-common: &airflow-common
  build:
    context: ./airflow
    dockerfile: Dockerfile
  networks:
    - elt_network
  environment: &airflow-env
    # Airflow metadata DB
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@airflow_postgres:5432/airflow

    # Auth manager for Airflow 3 (FAB)
    AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager

    AIRFLOW__CORE__HOSTNAME_CALLABLE: airflow.utils.net.get_host_ip_address

    # Local dev defaults
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__CORE__FERNET_KEY: plIipb9RU3-3wJ1UNaAtqVNJrqFEks1-dGbJM34EW7U=
    AIRFLOW__API__SECRET_KEY: secret
    AIRFLOW__CORE__LOAD_EXAMPLES: "False"

    # IMPORTANT: UI base url (for links & log URLs)
    AIRFLOW__WEBSERVER__BASE_URL: http://localhost:8080

    # IMPORTANT: served logs (fixes http://:8793/...)
    AIRFLOW__LOGGING__WORKER_LOG_SERVER_HOST: localhost
    AIRFLOW__LOGGING__WORKER_LOG_SERVER_PORT: 8793
    # This one prevents "empty host" in some setups:
    AIRFLOW__LOGGING__WORKER_LOG_SERVER_PROTOCOL: http

    # Optional: your ELT connections (inside docker network)
    AIRFLOW_CONN_SOURCE_POSTGRES: postgresql://source_user:source_password@source_postgres:5432/source_db
    AIRFLOW_CONN_DESTINATION_POSTGRES: postgresql://dest_user:dest_password@destination_postgres:5432/dest_db

  volumes:
    - ./airflow/dags:/opt/airflow/dags
    - ./elt:/opt/airflow/elt
    - ./custom_postgres:/opt/dbt
    - ${USERPROFILE}\.dbt:/root/.dbt
    - /var/run/docker.sock:/var/run/docker.sock

services:
  source_postgres:
    image: postgres:13
    container_name: source_postgres
    environment:
      POSTGRES_USER: source_user
      POSTGRES_PASSWORD: source_password
      POSTGRES_DB: source_db
    ports:
      - "5432:5432"
    volumes:
      - ./data/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - elt_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U source_user -d source_db"]
      interval: 5s
      timeout: 5s
      retries: 20

  destination_postgres:
    image: postgres:13
    container_name: destination_postgres
    environment:
      POSTGRES_USER: dest_user
      POSTGRES_PASSWORD: dest_password
      POSTGRES_DB: dest_db
    ports:
      - "5433:5432"
    networks:
      - elt_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dest_user -d dest_db"]
      interval: 5s
      timeout: 5s
      retries: 20

  airflow_postgres:
    image: postgres:13
    container_name: airflow_postgres
    networks:
      - elt_network
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airflow -d airflow"]
      interval: 5s
      timeout: 5s
      retries: 30

  # One-time init: migrate DB + create admin
  init-airflow:
    <<: *airflow-common
    container_name: airflow_init
    depends_on:
      airflow_postgres:
        condition: service_healthy
    restart: "no"
    user: root
    command: >
      bash -c "set -e; airflow db migrate; airflow users create -u airflow -p password -f John -l Doe -r Admin -e admin@example.com || true"


  # Airflow UI/API
  api-server:
    <<: *airflow-common
    container_name: airflow_api_server
    depends_on:
      airflow_postgres:
        condition: service_healthy
      init-airflow:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    user: root
    command: api-server

  # REQUIRED in Airflow 3 to parse DAGs reliably
  dag-processor:
    <<: *airflow-common
    container_name: airflow_dag_processor
    depends_on:
      airflow_postgres:
        condition: service_healthy
      init-airflow:
        condition: service_completed_successfully
    user: root
    command: dag-processor

  scheduler:
    <<: *airflow-common
    container_name: airflow_scheduler
    depends_on:
      airflow_postgres:
        condition: service_healthy
      init-airflow:
        condition: service_completed_successfully
    user: root
    command: scheduler
    ports:
    - "8793:8793"

networks:
  elt_network:
    driver: bridge
    name: elt_network
